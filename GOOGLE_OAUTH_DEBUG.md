# ğŸ” Google OAuth Profile Creation - Debug Guide

## âœ… Issues Fixed

### 1. **Schema Mismatch Fixed**
- âŒ **Problem**: Trying to insert `email` field that doesn't exist in profiles table
- âœ… **Solution**: Removed `email` field from insert statement
- âœ… **Solution**: Removed `created_at` and `updated_at` (auto-generated by database)

### 2. **Added Comprehensive Debugging**
Now you can see exactly what's happening during OAuth flow in browser console.

## ğŸ§ª How to Test & Debug

### **Step 1: Open Browser Console**
1. Go to your app
2. Open Developer Tools (F12)
3. Go to Console tab
4. Clear console for clean test

### **Step 2: Test Google OAuth**
1. Click "Sign in with Google"
2. Complete OAuth flow
3. Watch console messages

### **Expected Console Output:**
```
ğŸ”„ Auth state change: SIGNED_IN User: your@email.com
ğŸ‘¤ New sign-in detected, handling OAuth user...
ğŸ” Handling OAuth user: your@email.com ID: [user-id]
ğŸ” Existing profile check: Not found
ğŸ”¨ Creating new profile for OAuth user...
âœ… Google OAuth profile created successfully for user: your@email.com
```

### **If Profile Creation Fails:**
```
âŒ Error creating Google OAuth profile: [error details]
Full error details: [JSON error object]
```

## ğŸ”§ Current Profile Insert Schema

The profile creation now uses **only valid fields**:

```typescript
{
  auth_uid: user.id,              // âœ… Google user ID
  full_name: 'User Name',         // âœ… From Google profile
  role: 'guest',                  // âœ… Default role
  city: 'Unknown',                // âœ… Default city
  bio: null,                      // âœ… Empty bio
  verified: false                 // âœ… Not verified initially
}
```

## ğŸš¨ Troubleshooting Common Issues

### **Issue 1: "Column doesn't exist" Error**
- **Cause**: Trying to insert non-existent fields
- **Solution**: âœ… Fixed - only using valid schema fields

### **Issue 2: "RLS Policy" Error**
- **Cause**: Row Level Security blocking insert
- **Solution**: Check Supabase RLS policies for profiles table
- **Fix**: Ensure policy allows authenticated users to insert their own profile

### **Issue 3: "Auth state change not triggered"**
- **Cause**: OAuth callback not working properly
- **Debug**: Check if you see `ğŸ”„ Auth state change: SIGNED_IN` in console
- **Solution**: Verify Google OAuth redirect URLs are correct

### **Issue 4: "Profile check failing"**
- **Cause**: Database connection or query issue
- **Debug**: Look for `ğŸ” Existing profile check:` message
- **Solution**: Check Supabase connection and table permissions

## ğŸ” Debugging Checklist

**Console Messages to Look For:**
- [ ] `ğŸ”„ Auth state change: SIGNED_IN` - OAuth callback working
- [ ] `ğŸ‘¤ New sign-in detected` - SIGNED_IN event triggered  
- [ ] `ğŸ” Handling OAuth user` - OAuth handler called
- [ ] `ğŸ” Existing profile check: Not found` - Profile doesn't exist
- [ ] `ğŸ”¨ Creating new profile` - Profile creation started
- [ ] `âœ… Google OAuth profile created successfully` - Success!

**If Any Step is Missing:**
1. **Missing auth state change**: Check OAuth redirect URLs
2. **Missing OAuth handler**: Check auth state listener setup
3. **Missing profile check**: Check database connection
4. **Missing profile creation**: Check RLS policies and schema

## ğŸ¯ Next Steps After Testing

1. **Test with fresh Google account** (one not used before)
2. **Check Supabase Dashboard** â†’ Table Editor â†’ profiles
3. **Verify new profile row exists** with correct data
4. **Test app functionality** with the new OAuth user

The system should now work correctly! ğŸš€

